хранилище редис это словарь

fsm создает записи стейтов с ключами в формате 'fsm:chat_id:user_id:state'      значение     текущий стейт
и, начиная сессию, создавать запись с ключом 'chat_id:user_id:session'          значение     пустой словарь

обязательно по каждому действию обновлять поле dt_dateupd

в конце сессии очистить и словарь и стейты

если юзер вываливается посреди сессии, то надо удалить его словарь через полчаса бездействия
стейт лучше тоже удалить




разобраться с хранилищем. наверняка этот механизм уже реализован